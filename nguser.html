<!DOCTYPE html>
<head>
<meta charset="UTF-8">
</head>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<body>

<div ng-app="myApp" ng-controller="personCtrl">

Kennung: <input type="text" ng-model="inputVal" ng-change="readnew()"><br>

<div ng-show=isLbs()>LBS</div>
<div ng-show=isRfid()>Cardnumber</div>
<div ng-show=isRz()>RZ</div>


<div ng-show=true>
<br>RZ: {{fullName()}}
     <br>generationQualifier: {{genQual()}}
<div class=alert ng-show=!generationQualifierValid()>LBS Kennung fehlt in trust:  {{rz.generationQualifier}}</div>
<br>carLicense:{{rz.carLicense}}
<br>employeeType: {{rz.employeeType}}
<br>mail: {{rz.mail}}
</div>

<div ng-show=true>
  <br>LBS: {{lbs.cn}}
  <br>dn: {{lbs.displayName}}
  <br>mail: {{lbs.mail}}
<br>Grp: {{lbs.Grp}}
<br>Ablauf: {{lbs.Ablauf}}
</div>


<div class=alert ng-show=generationQualifierDiff()>generationQualifierDiff</div>

Â <br>{{statcode}} ({{stattext}})
<div ng-show=done>done</div>
</div>

<script>
  var lbspattern=/0705\d{6}[\dxX]/;
  var carlicpattern=/\d{8-10}/;
  var rzpattern=/[a-z]\w{2,}/;
  
  var app = angular.module('myApp', []);
  
  var rzresult={cn:"init",generationQualifier:"0705443",carLicense:"333444",employeeType:"facu"};
  
  var lbsresult={uid:"0705432",Grp:"20",Ablauf:"20.03.2020"};

  app.controller("personCtrl",function($scope, $http) {
      	  $scope.done=false;
	  $scope.rz={};
	  $scope.lbs={};
	  $scope.inputVal="";

	  $scope.fullName = function() {
	      var x = $scope.rz;
	      return x.cn;
	  };

    $scope.genQual=function(){
	
	if(!$scope.done && !$scope.lbs.cn && $scope.generationQualifierValid()){ // check with retrieved patron code
	    $scope.lbs.Grp="second request";
	    $scope.done=true; // only once?
//	return $scope.rz.generationQualifier;

	    $http.get("processes/userjson.php?q="+$scope.rz.generationQualifier)
		.then(function(response){
			$scope.lbs=response.data.lbs;
			$scope.statcode=response.status;
			$scope.stattext=response.statusText;
		    });
	}
	
	$scope.lbs.Ablauf="request2";

	return $scope.rz.generationQualifier;
    };

      $scope.readnew=function(){

	  if(2 < $scope.inputVal.length){ // no id below 3 chars
	      $scope.lbs.Grp = "request1";
	      $scope.done=false;

	    $http.get("processes/userjson.php?q="+$scope.inputVal)
		.then(function(response){
		    $scope.rz=response.data.rz;
		    $scope.lbs=response.data.lbs;
		    $scope.statcode=response.status;
		    $scope.stattext=response.statusText;
		});
	
	  }
      };
      
      $scope.isLbs=function(){
	  return lbspattern.test($scope.inputVal);
      };

      $scope.isRfid=function(){
	  return carlicpattern.test($scope.inputVal);
      };
      
      $scope.isRz=function(){
	  return rzpattern.test($scope.inputVal);
      };
    
      $scope.generationQualifierDiff=function(){
	  return ($scope.rz.generationQualifier != $scope.lbs.cn);
      };

    
      $scope.generationQualifierValid=function(){
	  if($scope.rz.generationQualifier)
	      return $scope.rz.generationQualifier.startsWith('0705');
	  else return false;
      };

  });

</script>

</body>
</html>
