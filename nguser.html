<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<body>

  <style>
    div {font:SansSerif;}
    .hint {background-color:yellow;}
    .alert {background-color:red;}
    th {padding:1em;
	   width:15em;}
    th.col2 {width:3em;}
    .input {font-weight: bold;}
  </style>
  
<div ng-app="myApp" ng-controller="personCtrl">

<h2>Benutzeranfrage</h2>
Kennung: <input type="text" ng-model="inputVal" ng-change="readnew()">

<span ng-show=isLbs()>erkannt: LBS</span>
<span ng-show=isRfid()>erkannt: Cardnumber</span>
<span ng-show=isRz()>erkannt: RZ</span>


<table class="w3-table w3-bordered w3-striped">
  <tr><th>RZ</th><th class="col2 "></th><th>ldap</th><th>LBS</th></tr>

  <tr><td ng-class={input:isRz()}>{{rz.cn}}</td><td></td><td ng-class={input:isLbs()}><input type="text" ng-model="bib.cn" ng-blur=freshBib(bib.cn)></td></tr>
  <tr><td>{{rz.displayName}}</td><td></td><td>{{bib.displayName}}</td><td>{{lbs4.displayName}}</td></tr>
  <tr ng-show=generationQualifierDiff()><td>{{rz.generationQualifier}}</td><td ng-class={hint:generationQualifierDiff()}></td><td>{{bib.cn}}</td></tr>
  <tr ng-show=generationQualifierDiff()><td></td><td></td><td class="hint">LDAP Eintrag?</td><td class="hint" ng-show=lbsMiss()>LBS Eintrag?</td></tr>
  <tr><td ng-class={input:isRfid()}>{{rz.carLicense}}</td><td ng-class={hint:carLicDiff()}></td><td>{{bib.carLicense}}</td></tr>
  <tr><td>{{rz.mail}}</td><td></td><td>{{bib.mail}}</td><td>{{lbs4.mail}}</td></tr>
  <tr><td>{{rz.employeeType}}</td><td></td><td></td><td>{{lbs4.grp}}</td></tr>
  <tr><td></td><td></td><td></td><td ng-class={hint:isLocked()}>Status {{lbs4.status}}</td></tr>

</table>

<ul>
<li class=alert ng-show= !generationQualifierValid()>LBS Kennung ungültig in trust</li>
<li class=alert ng-show=false  generationQualifierDiff())>generationQualifier</li>
<li class=alert ng-show=isLocked()>Benutzer gesperrt: Status {{lbs4.status}}</li>
<li class=alert ng-show=lbsMiss()>Benutzernummer nicht im LBS: {{rz.generationQualifier}}</li>
</ul>

<input type="checkbox" ng-model="debug" />
<div ng-show=debug>
<br>RZ: {{fullName()}}
<br>dn: {{rz.displayName}}
<br>generationQualifier: {{genQual()}}
<br>carLicense:{{rz.carLicense}}
<br>employeeType: {{rz.employeeType}}
<br>mail: {{rz.mail}}
</div>

<div ng-show=debug>
  <br>ldap: <input type="text" ng-model="bib.cn" />
  <br>dn: {{bib.displayName}}
<br>carLicense:{{bib.carLicense}}
  <br>mail: {{bib.mail}}
<br>Request: {{bib.Grp}}
<br>Ablauf: {{bib.Ablauf}}
</div>

<div ng-show=debug>
  <br>LBS: <input type="text" ng-model="lbs4.cn" />
  <br>dn: {{lbs4.displayName}}
  <br>mail: {{lbs4.mail}}
<br>Grp: {{lbs4.grp}}
<br>Ablauf: {{lbs4.ablauf}}

 <br>{{statcode}} ({{stattext}})
<div ng-show=done>done</div>
</div>



</div>

<script>
  var lbspattern=/0705\d{6}[\dxX]/;
  var carlicpattern=/[1-9]\d{7,9}/;
  var rzpattern=/[a-z]\w{2,}/;
  
  var app = angular.module('myApp', []);
  
  var rzresult={cn:"init",generationQualifier:"0705443",carLicense:"333444",employeeType:"facu"};
  
  var lbsresult={uid:"0705432",Grp:"20",Ablauf:"20.03.2020"};

  app.controller("personCtrl",function($scope, $http) {
      $scope.debug=0;
      $scope.done=false;
	  $scope.rz={};
	  $scope.bib={};
	  $scope.lbs4={};
	  $scope.inputVal="";

	  $scope.fullName = function() {
	      var x = $scope.rz;
	      return x.cn;
	  };

      $scope.freshBib=function(query){
	  $scope.freshLdap(query);
	  $scope.freshLBS(query);
      }
      
      $scope.freshRz=function(query){
          $http({url:"processes/userjson.php",
		 data:"q="+query,
		 method:"POST",
		 headers: {'Content-Type': 'application/x-www-form-urlencoded'},
		})
              .then(function(response){
                  $scope.rz=response.data.rz;
                  $scope.bib=response.data.bib;
                  $scope.statcode=response.status;
                  $scope.stattext=response.statusText;
              });	  
      }

      $scope.freshLdap=function(query){
          $http({url:"processes/userjson.php",
		 data:"q="+query,
		 method:"POST",
		 headers: {'Content-Type': 'application/x-www-form-urlencoded'},
		})
              .then(function(response){
                  $scope.bib=response.data.bib;
                  $scope.statcode=response.status;
                  $scope.stattext=response.statusText;
              });	  
      }

      $scope.freshLBS=function(query){
	  var jsq={"q":query,"jsonp2":"value2"};
	  jsq="debu=22&q="+query;
          $http({url:"https://intranet.ub.hsu-hh.de/cgi-bin/signatur-dev/borjson.cgi",
		 data:jsq,
		 method:'POST',
		 headers: {'Content-Type': 'application/x-www-form-urlencoded'},
//		 paramSerializer:'$httpParamSerializerJQLike'
		})
              .then(function(response){
                  $scope.lbs4=response.data.lbs4;
                  $scope.statcode=response.status;
                  $scope.stattext=response.statusText;
              });	  
      }
      
    $scope.genQual=function(){
	if(!$scope.done && !$scope.bib.cn && $scope.generationQualifierValid()){ // check with retrieved patron code
	    $scope.bib.Grp="second request";
	    $scope.done=true; // only once?

	    $scope.freshBib($scope.rz.generationQualifier);
	}
	
	$scope.bib.Ablauf="request2";

	return $scope.rz.generationQualifier;
    };

      $scope.readnew=function(){

	  if(2 < $scope.inputVal.length){ // no id below 3 chars
	      $scope.bib.Grp = "request1";
	      $scope.lbs4={};
	      $scope.done=false;

	      $scope.freshRz($scope.inputVal);
	      if($scope.isLbs()){
		  $scope.freshLBS($scope.inputVal)
	      }
	  }
      };
      
      $scope.isLbs=function(){
	  return lbspattern.test($scope.inputVal);
      };

      $scope.isRfid=function(){
	  return carlicpattern.test($scope.inputVal);
      };
      
      $scope.isRz=function(){
	  return rzpattern.test($scope.inputVal);
      };
    
      $scope.carLicDiff=function(){
	  if($scope.bib.carLicense)
	      return ($scope.rz.carLicense != $scope.bib.carLicense);
	  else return false;
      };

      $scope.generationQualifierDiff=function(){
	  if($scope.rz.generationQualifier)
	      return ($scope.rz.generationQualifier != $scope.bib.cn);
	  else return false;
      };

    
      $scope.generationQualifierValid=function(){
	  if($scope.rz.generationQualifier)
	      return $scope.rz.generationQualifier.startsWith('0705');
	  else return false;
      };

      $scope.isLocked=function(){
	  if($scope.lbs4.status)
	      return (0 < $scope.lbs4.status);

	  return false;
      };

      $scope.lbsMiss=function(){
	  if($scope.lbs4.grp)
	      return false;
	  else
	      return true;
	  
      };

  });

</script>

</body>
</html>
